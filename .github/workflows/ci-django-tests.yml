name: Top Pet System - CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Define um serviÃ§o de banco de dados que rodarÃ¡ durante os testes
    services:
      postgres:
        image: postgres:13
        # Define as credenciais para o banco de dados de teste
        env:
          POSTGRES_DB: top_pet_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        # Verifica se o banco estÃ¡ pronto antes de continuar
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ³ Build dos containers Docker
        run: docker compose build web
        
      - name: ğŸ” Verificar estrutura do projeto
        run: |
          echo "ğŸ“‚ Verificando estrutura do projeto..."
          ls -la backend/
          echo "ğŸ“¦ Apps Django encontrados:"
          ls -la backend/*/
        
      - name: ğŸ”§ Aplicar migraÃ§Ãµes
        run: docker compose run --rm web python manage.py migrate
        env:
          POSTGRES_NAME: top_pet_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: postgres
          
      - name: ğŸ§ª Executar testes - Users App
        run: docker compose run --rm web python manage.py test users.tests -v 2
        env:
          POSTGRES_NAME: top_pet_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: postgres
          
      - name: ğŸ• Executar testes - Pets App
        run: docker compose run --rm web python manage.py test pets.tests -v 2
        env:
          POSTGRES_NAME: top_pet_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: postgres
          
      - name: ğŸ“… Executar testes - Agendamentos App
        run: docker compose run --rm web python manage.py test agendamentos.tests -v 2
        env:
          POSTGRES_NAME: top_pet_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: postgres
          
      - name: ğŸ¥ Executar testes - Prontuarios App
        run: docker compose run --rm web python manage.py test prontuarios.tests -v 2
        env:
          POSTGRES_NAME: top_pet_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: postgres
          
      - name: ğŸš€ Executar todos os testes do sistema
        run: docker compose run --rm web python manage.py test --verbosity=2
        env:
          POSTGRES_NAME: top_pet_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: postgres
          
      - name: ğŸ“Š Verificar cobertura de cÃ³digo (opcional)
        run: |
          echo "âœ… Testes concluÃ­dos com sucesso!"
          echo "ğŸ“ˆ Apps testados:"
          echo "  - ğŸ‘¥ Users: AutenticaÃ§Ã£o e perfis"
          echo "  - ğŸ• Pets: Cadastro e gestÃ£o de pets"
          echo "  - ğŸ“… Agendamentos: Sistema de agendamento"
          echo "  - ğŸ¥ Prontuarios: Registros mÃ©dicos"
          
      - name: ğŸ§¹ Limpeza dos containers
        if: always()
        run: docker compose down --volumes --remove-orphans